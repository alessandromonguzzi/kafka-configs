# How to use kafka connect to push messages into elasticsearch using HTTPS

Requirements:
1) kafka_2.12-2.5.0 https://kafka.apache.org/downloads
2) elasticsearch-7.7.0 https://www.elastic.co/downloads/elasticsearch
3) camel-elasticsearch-rest-kafka-connector: https://github.com/apache/camel-kafka-connector

### Camel-kafka-connector setup
Clone above repository
```
mvn clean package 
```
the camel-elasticsearch-rest-kafka-connector directory is located in:
```
core/target/camel-kafka-connector-*-package/share/java/
```
As alternative, the same is available here:

https://repo1.maven.org/maven2/org/apache/camel/kafkaconnector/camel-elasticsearch-rest-kafka-connector/0.2.0/camel-elasticsearch-rest-kafka-connector-0.2.0-package.zip

Important note, it seems that log4j2 dependencies required by elasticsearch are missing. So download them manually

https://repo1.maven.org/maven2/org/apache/logging/log4j/log4j-core/2.13.3/log4j-core-2.13.3.jar

https://repo1.maven.org/maven2/org/apache/logging/log4j/log4j-api/2.13.3/log4j-api-2.13.3.jar

### Elasticsearch setup
```
cd elasticsearch-7.7.0
```

Important NOTE needed dns specification inside certificate generated by elasticsearch-certutil tool.
The instructions below assume that elasticsearch and kafka-connect runs on the same host and they use "localhost" as DNS name for elasticsearch. Replace localhost with the correct DNS name for other cases.
Generate certificates for elasticsearch and configure it:
```
bin/elasticsearch-certutil cert ca --pem --in instance.yml --dns localhost
unzip -d certificates certificate-bundle.zip
mv certificates/ config/
```

Add the lines below to the elasticsearch.yml file.
```
# This turns on SSL for the HTTP (Rest) interface
xpack.security.http.ssl.enabled: true

# This configures the keystore to use for SSL on HTTP
xpack.security.http.ssl.key: certificates/localhost/localhost.key
xpack.security.http.ssl.certificate: certificates/localhost/localhost.crt
xpack.security.http.ssl.certificate_authorities: certificates/ca/ca.crt
xpack.security.http.ssl.client_authentication: optional
```
Launch elasticsearch
```
bin/elasticsearch
```
Configure username and passwords for elasticsearch
```
bin/elasticsearch-setup-passwords auto -u "https://localhost:9200"
```
Copy the above passwords and use them to update the `elasticSinkTaskLocalSSL.json` file.

### Kafka setup
The below configuration is based on a single broker, single zookeeper, single kafka-connect instance, adapt provided configuration for different scenarios.
```
cd kafka_2.12-2.5.0
```
Launch zookeeper
```
./bin/zookeeper-server-start.sh config/zookeeper.properties
```
Launch kakfa
```
./bin/kafka-server-start.sh config/server.properties
```
Create a new topic `my-topic` in kafka
```
./bin/kafka-topics.sh --zookeeper localhost:2181 --create --topic my-topic --partitions 1 --replication-factor 1
```
### Kafka-connect setup
Generate a truststore to connect with elasticsearch. Watchout, you need only the .crt file to do this step, but move from PKCS12 to JKS
``` 
keytool -import -alias localhost -file elasticsearch-7.7.0/config/certificates/localhost/localhost.crt -storetype JKS -keystore server.truststore
```
remember the password that you define in the `server.truststore` and use it in the `javax.net.ssl.trustStorePassword` property below. In the example the `es1234` password is used.

create a plugin directory inside kakfa installation
```
mkdir plugins
cp -r camel-elasticsearch-rest-kafka-connector plugins
```
Launch kafka-connect that is listening on port 8083
```
EXTRA_ARGS="-Djavax.net.ssl.trustStore=server.truststore -Djavax.net.ssl.trustStorePassword=es1234" bin/connect-distributed.sh connect-0.properties
```
Register camel-es-connector to kafka-connect
```
curl -sX POST -H "Content-Type: application/json" localhost:8083/connectors -d@elasticSinkTaskLocalSSL.json
```

Generate a message using `bin/kafka-console-producer.sh` (NOTE: message must be in JSON format, normal String does not work)
```
echo '{"data":"Hello World"}' | bin/kafka-console-producer.sh --broker-list localhost:9092 --topic my-topic
```

command to verify content of elasticsearch on topic `my-topic`; it can take some time (<1min for kafka-connect to work).
```
curl -k -u elastic:<password here> https://localhost:9200/my-topic/_search
```

Some useful links:

https://www.elastic.co/blog/configuring-ssl-tls-and-https-to-secure-elasticsearch-kibana-beats-and-logstash
https://www.elastic.co/guide/en/elasticsearch/reference/current/configuring-tls.html
https://www.elastic.co/blog/elasticsearch-security-configure-tls-ssl-pki-authentication
https://www.elastic.co/guide/en/elasticsearch/client/java-rest/current/_encrypted_communication.html
https://camel.apache.org/camel-kafka-connector/latest/connectors/camel-elasticsearch-rest-kafka-sink-connector.html

